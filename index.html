<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TETRIS ART STUDIO DELUXE ¬∑ LOCAL STORAGE</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --tetris-cyan: #00f0f0;
            --tetris-blue: #0000f0;
            --tetris-orange: #f0a000;
            --tetris-yellow: #f0f000;
            --tetris-green: #00f000;
            --tetris-purple: #a000f0;
            --tetris-red: #f00000;
            --bg-dark: #0a0a1f;
            --bg-panel: rgba(20, 20, 35, 0.95);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            width: 100vw; height: 100vh;
            background: linear-gradient(135deg, #0a0a1f 0%, #1a1a3a 50%, #0a0a1f 100%);
            font-family: 'Rajdhani', sans-serif;
            color: white;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-image 0.3s ease;
            background-size: cover; /* Make background cover entire area */
            background-position: center;
            background-repeat: no-repeat;
        }

        .crt-overlay { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%), linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03)); background-size: 100% 3px, 6px 100%; animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.95; } 50% { opacity: 1; } 100% { opacity: 0.98; } }

        .floating-blocks { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:-1; opacity:0.1; }
        .floating-block { position: absolute; width:60px; height:60px; background:var(--tetris-cyan); opacity:0.3; transform:rotate(45deg); animation:float 20s infinite linear; }
        @keyframes float { 0% { transform: translateY(-100px) rotate(0deg); } 100% { transform: translateY(100vh) rotate(360deg); } }

        #loading-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:#0a0a1f; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:10000; transition:opacity 0.5s; }
        .tetris-loader { font-family:'Press Start 2P'; font-size:32px; color:var(--tetris-cyan); text-shadow:0 0 20px var(--tetris-cyan); margin-bottom:20px; }
        .loading-bar { width:300px; height:20px; border:2px solid var(--tetris-cyan); }
        .loading-progress { width:0%; height:100%; background:linear-gradient(90deg, var(--tetris-cyan), var(--tetris-purple)); animation:load 2s forwards; }
        @keyframes load { to { width:100%; } }

        /* login screen */
        #login-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg,#0a0a1f,#1a1a3a); display:flex; justify-content:center; align-items:center; z-index:1000; transition:transform 0.8s cubic-bezier(0.68,-0.55,0.265,1.55); }
        #login-screen.hidden { transform:scale(0); pointer-events:none; }
        .login-container { background:var(--bg-panel); padding:40px; border:4px solid var(--tetris-cyan); box-shadow:0 0 20px var(--tetris-cyan),0 0 40px var(--tetris-purple); text-align:center; width:400px; backdrop-filter:blur(10px); }
        .login-container::before { content:'TETRIS'; position:absolute; top:-25px; left:50%; transform:translateX(-50%); background:linear-gradient(90deg,var(--tetris-cyan),var(--tetris-purple)); color:black; padding:5px 20px; font-family:'Press Start 2P'; font-size:14px; }
        .login-title { font-family:'Press Start 2P'; font-size:24px; margin:30px 0 40px; text-shadow:3px 3px var(--tetris-purple),6px 6px var(--tetris-cyan); }

        #register-modal, #bg-preview-modal, #profile-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:2000; opacity:0; pointer-events:none; transition:opacity 0.3s; backdrop-filter:blur(5px); }
        #register-modal.active, #bg-preview-modal.active, #profile-modal.active { opacity:1; pointer-events:all; }
        .modal-content, .preview-container { background:var(--bg-panel); padding:30px; border:4px solid var(--tetris-green); box-shadow:0 0 30px var(--tetris-green); max-width:90vw; max-height:90vh; overflow:auto; }
        .close-modal { position:absolute; top:10px; right:15px; color:#888; font-size:24px; cursor:pointer; }
        .close-modal:hover { color:var(--tetris-red); }

        /* PROFILE GALLERY */
        .profile-gallery { display:grid; grid-template-columns:repeat(auto-fill, minmax(160px,1fr)); gap:15px; margin-top:20px; max-height:60vh; overflow-y:auto; padding:10px; }
        .gallery-item { background:rgba(0,0,0,0.6); border:2px solid var(--tetris-cyan); padding:10px; cursor:pointer; transition:0.2s; }
        .gallery-item:hover { border-color:var(--tetris-yellow); transform:scale(1.02); }
        .gallery-item canvas { width:100%; height:auto; border:1px solid #333; background:#0a0a1f; }
        .gallery-stats { font-size:11px; margin-top:5px; color:var(--tetris-cyan); display:flex; flex-direction:column; gap:3px; }
        .gallery-username { color:var(--tetris-yellow); font-weight:bold; }

        /* main app */
        #app-container { display:none; width:95vw; height:90vh; max-width:1800px; background:rgba(20,20,35,0.85); backdrop-filter:blur(10px); border:4px solid var(--tetris-cyan); box-shadow:0 0 20px var(--tetris-cyan),0 0 40px var(--tetris-purple); }
        #app-container.visible { display:flex; animation:slideIn 0.6s; }
        @keyframes slideIn { from { opacity:0; transform:translateY(50px); } to { opacity:1; transform:translateY(0); } }

        #sidebar { width:380px; background:rgba(0,0,0,0.6); backdrop-filter:blur(10px); border-right:4px solid var(--tetris-cyan); padding:20px; display:flex; flex-direction:column; gap:15px; overflow-y:auto; }
        .user-info { background:linear-gradient(135deg, rgba(0,240,240,0.1), rgba(160,0,240,0.1)); padding:15px; border:2px solid var(--tetris-cyan); display:flex; align-items:center; gap:15px; }
        .user-avatar { width:50px; height:50px; background:linear-gradient(135deg,var(--tetris-cyan),var(--tetris-purple)); display:flex; justify-content:center; align-items:center; font-family:'Press Start 2P'; font-size:20px; color:black; }
        .section-title { font-family:'Press Start 2P'; font-size:10px; color:var(--tetris-yellow); margin-bottom:10px; text-shadow:0 0 5px var(--tetris-yellow); }
        .shape-grid, .color-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
        .shape-btn, .color-btn { aspect-ratio:1; background:rgba(255,255,255,0.1); border:2px solid #444; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; }
        .shape-btn:hover, .color-btn:hover { border-color:var(--tetris-cyan); box-shadow:0 0 15px var(--tetris-cyan); transform:scale(1.05); }
        .shape-btn.active, .color-btn.active { border-color:var(--tetris-cyan); box-shadow:0 0 15px var(--tetris-cyan); background:rgba(0,240,240,0.2); }
        .color-btn { border:3px solid transparent; box-shadow:0 0 5px currentColor; }

        .custom-color-section { margin-top:10px; padding:10px; background:rgba(0,0,0,0.3); border:1px solid #333; }
        .color-picker-row { display:flex; gap:10px; align-items:center; }
        #custom-color { width:50px; height:50px; border:2px solid var(--tetris-cyan); }
        .hex-input { flex:1; padding:10px; background:rgba(0,0,0,0.5); border:2px solid #333; color:var(--tetris-cyan); font-family:monospace; }

        .block-type-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:10px; }
        .block-type-btn { padding:10px; background:rgba(255,255,255,0.05); border:2px solid #444; color:white; cursor:pointer; text-align:center; }
        .block-type-btn.active { border-color:var(--tetris-cyan); background:rgba(0,240,240,0.2); }

        .slider-control { margin:10px 0; }
        .slider-label { display:flex; justify-content:space-between; color:var(--tetris-cyan); font-size:12px; }
        .slider { width:100%; height:8px; background:#333; -webkit-appearance:none; }
        .slider::-webkit-slider-thumb { -webkit-appearance:none; width:20px; height:20px; background:var(--tetris-cyan); border:2px solid white; box-shadow:0 0 10px var(--tetris-cyan); cursor:pointer; }

        .toggle-switch { display:flex; align-items:center; gap:10px; margin:10px 0; }
        .switch { position:relative; display:inline-block; width:60px; height:30px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider-toggle { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#333; transition:.2s; border-radius:30px; }
        .slider-toggle:before { position:absolute; content:""; height:22px; width:22px; left:4px; bottom:4px; background:white; transition:.2s; border-radius:50%; }
        input:checked + .slider-toggle { background-color:var(--tetris-cyan); }
        input:checked + .slider-toggle:before { transform:translateX(30px); }

        .toolbar { display:flex; flex-direction:column; gap:8px; }
        .tool-btn { padding:12px; background:rgba(255,255,255,0.05); border:2px solid #444; color:white; font-family:'Rajdhani',sans-serif; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:10px; transition:0.2s; }
        .tool-btn:hover { border-color:var(--tetris-cyan); box-shadow:0 0 10px var(--tetris-cyan); }
        .tool-btn.primary { background:linear-gradient(90deg,var(--tetris-cyan),var(--tetris-blue)); border:none; color:black; }
        .tool-btn.success { background:linear-gradient(90deg,var(--tetris-green),#00a000); border:none; color:black; }

        #canvas-area { flex:1; display:flex; flex-direction:column; position:relative; overflow:hidden; }
        #canvas-header { padding:15px 25px; background:rgba(0,0,0,0.5); border-bottom:2px solid var(--tetris-cyan); display:flex; justify-content:space-between; align-items:center; }
        #canvas-title { font-family:'Press Start 2P'; font-size:14px; color:var(--tetris-cyan); }
        #canvas-stats { display:flex; gap:20px; font-size:12px; }
        
        /* Canvas background can be set separately */
        #canvas-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #0a0a1f;
            transition: background-image 0.3s ease;
            overflow: auto;
            padding: 10px;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        #art-canvas {
            border: 3px solid var(--tetris-cyan);
            box-shadow: 0 0 30px var(--tetris-cyan), inset 0 0 50px rgba(0,240,240,0.2);
            cursor: crosshair;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background: #000000;
        }

        #block-preview { position:fixed; pointer-events:none; z-index:100; display:none; filter:drop-shadow(0 0 10px currentColor); }

        #notification { position:fixed; top:20px; right:20px; padding:15px 25px; background:linear-gradient(90deg,var(--tetris-green),#00a000); color:black; font-weight:bold; z-index:10000; transform:translateX(150%); transition:transform 0.3s; box-shadow:0 0 20px var(--tetris-green); border:2px solid white; }
        #notification.show { transform:translateX(0); }
        #notification.error { background:linear-gradient(90deg,var(--tetris-red),#a00000); color:white; }

        .input-group { margin-bottom:20px; text-align:left; }
        .input-group label { display:block; margin-bottom:8px; color:var(--tetris-cyan); }
        .input-group input { width:100%; padding:15px; background:rgba(0,0,0,0.5); border:2px solid #333; border-left:4px solid var(--tetris-cyan); color:white; font-size:18px; }
        .login-btn { width:100%; padding:18px; background:linear-gradient(90deg,var(--tetris-cyan),var(--tetris-purple)); border:none; color:black; font-family:'Press Start 2P'; font-size:12px; cursor:pointer; }
        .register-link a { color:var(--tetris-yellow); cursor:pointer; }
    </style>
</head>
<body>
    <div class="floating-blocks" id="floating-blocks"></div>
    <div class="crt-overlay"></div>

    <div id="loading-screen">
        <div class="tetris-loader">TETRIS</div>
        <div class="loading-bar"><div class="loading-progress"></div></div>
        <p style="margin-top:20px; color:#00f0f0;">LOADING SYSTEM...</p>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-title">ART STUDIO</div>
            <div class="input-group"><label>EMAIL</label><input type="email" id="login-email" placeholder="Enter email..."></div>
            <div class="input-group"><label>PASSWORD</label><input type="password" id="login-password" placeholder="Enter password..."></div>
            <button class="login-btn" onclick="handleLogin()">LOGIN</button>
            <div class="register-link">New player? <a onclick="showRegisterModal()">Create Account</a></div>
        </div>
    </div>

    <!-- REGISTER MODAL -->
    <div id="register-modal">
        <div class="modal-content"><span class="close-modal" onclick="hideRegisterModal()">&times;</span>
            <div class="login-title">REGISTER</div>
            <div class="input-group"><label>USERNAME</label><input type="text" id="reg-username"></div>
            <div class="input-group"><label>EMAIL</label><input type="email" id="reg-email"></div>
            <div class="input-group"><label>PASSWORD</label><input type="password" id="reg-password"></div>
            <div class="input-group"><label>CONFIRM</label><input type="password" id="reg-confirm"></div>
            <button class="login-btn" onclick="handleRegister()" style="background:linear-gradient(90deg,var(--tetris-green),#00a000);">CREATE ACCOUNT</button>
        </div>
    </div>

    <!-- BG PREVIEW MODAL (for main page background) -->
    <div id="bg-preview-modal">
        <div class="preview-container">
            <canvas id="bg-preview-canvas" style="border:2px solid #444; margin-bottom:20px; max-width:100%;"></canvas>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="tool-btn success" onclick="confirmApplyBackground()"><span class="icon">‚úì</span> APPLY AS PAGE BG</button>
                <button class="tool-btn" onclick="hideBackgroundPreview()"><span class="icon">‚úó</span> CANCEL</button>
            </div>
        </div>
    </div>

    <!-- PROFILE MODAL (with localStorage designs) -->
    <div id="profile-modal">
        <div class="modal-content" style="width:800px; max-width:90vw;">
            <span class="close-modal" onclick="hideProfileModal()">&times;</span>
            <div class="login-title" style="font-size:20px;">üë§ PLAYER DESIGNS</div>
            <div style="display:flex; gap:20px; margin-bottom:20px; background:rgba(0,0,0,0.5); padding:15px;">
                <div><span style="color:var(--tetris-cyan);">TOTAL BLOCKS USED:</span> <strong id="total-blocks-all">0</strong></div>
                <div><span style="color:var(--tetris-yellow);">DESIGNS:</span> <strong id="total-designs">0</strong></div>
            </div>
            <div id="profile-gallery" class="profile-gallery"></div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                <button class="tool-btn success" onclick="saveDesignToLocal()"><span class="icon">üíæ</span> SAVE CURRENT DESIGN</button>
                <button class="tool-btn" onclick="hideProfileModal()">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container">
        <div id="sidebar">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">T</div>
                <div><h3 id="display-username">PLAYER</h3><p style="color:var(--tetris-cyan);">LEVEL <span id="user-level">1</span></p></div>
            </div>
            <div><div class="section-title">üî∑ BLOCKS</div><div class="shape-grid" id="shape-selector"></div></div>
            <div><div class="section-title">üé® COLORS</div><div class="color-grid" id="color-picker"></div>
                <div class="custom-color-section"><div class="color-picker-row"><input type="color" id="custom-color" value="#00f0f0"><input type="text" class="hex-input" id="custom-hex" value="#00f0f0"></div><button class="tool-btn" onclick="applyCustomColor()" style="width:100%;">USE CUSTOM COLOR</button></div>
            </div>
            <div><div class="section-title">‚ú® BLOCK STYLE</div><div class="block-type-grid"><button class="block-type-btn active" onclick="setBlockType('solid')">SOLID</button><button class="block-type-btn" onclick="setBlockType('outline')">OUTLINE</button><button class="block-type-btn" onclick="setBlockType('glow')">GLOW</button><button class="block-type-btn" onclick="setBlockType('3d')">3D</button></div></div>
            <div><div class="section-title">‚ö° EFFECTS</div>
                <div class="toggle-switch"><span>üîä SOUND</span><label class="switch"><input type="checkbox" id="sound-toggle" checked><span class="slider-toggle"></span></label></div>
                <div class="slider-control"><div class="slider-label"><span>üîÆ OPACITY</span><span id="opacity-value">100%</span></div><input type="range" id="opacity-slider" class="slider" min="0.1" max="1" step="0.1" value="1"></div>
                <div class="slider-control"><div class="slider-label"><span>üîç CANVAS SCALE</span><span id="scale-value">100%</span></div><input type="range" id="scale-slider" class="slider" min="0.5" max="1.8" step="0.1" value="1"></div>
            </div>
            <div><div class="section-title">üõ†Ô∏è TOOLS</div><div class="toolbar"><button class="tool-btn" onclick="rotateShape()"><span class="icon">‚Üª</span> ROTATE (R)</button><button class="tool-btn" onclick="undoAction()"><span class="icon">‚Ü©</span> UNDO</button><button class="tool-btn" onclick="clearCanvas()"><span class="icon">üóë</span> CLEAR</button></div></div>
            <div><div class="section-title">üíæ ACTIONS</div><div class="toolbar">
                <button class="tool-btn success" onclick="previewBackground()"><span class="icon">üëÅ</span> PREVIEW PAGE BG</button>
                <button class="tool-btn" onclick="setCanvasBackground()"><span class="icon">üñºÔ∏è</span> SET CANVAS BG</button>
                <button class="tool-btn primary" onclick="saveDesignToLocal()"><span class="icon">üíæ</span> SAVE LOCAL</button>
                <button class="tool-btn" onclick="showLocalDesigns()"><span class="icon">üìã</span> MY DESIGNS</button>
                <button class="tool-btn" onclick="downloadBackground()"><span class="icon">‚¨á</span> DOWNLOAD PNG</button>
                <button class="tool-btn" onclick="logout()"><span class="icon">üö™</span> LOGOUT</button>
            </div></div>
            <div style="background:rgba(0,0,0,0.3); padding:10px; font-size:11px;">
                <div style="display:flex; justify-content:space-between;"><span>Left Click</span><span style="background:#333; padding:2px 6px;">Place</span></div>
                <div style="display:flex; justify-content:space-between;"><span>Right Click</span><span style="background:#333; padding:2px 6px;">Delete</span></div>
                <div style="display:flex; justify-content:space-between;"><span>Scroll</span><span style="background:#333; padding:2px 6px;">Rotate</span></div>
            </div>
        </div>
        <div id="canvas-area">
            <div id="canvas-header"><div id="canvas-title">üéÆ TETRIS CANVAS</div><div id="canvas-stats"><span>BLOCKS: <strong id="block-count">0</strong></span><span>GRID: 32x18</span></div></div>
            <div id="canvas-wrapper"><canvas id="art-canvas"></canvas></div>
        </div>
    </div>

    <canvas id="block-preview"></canvas>
    <div id="notification"></div>

    <script>
        (function() {
            const firebaseConfig = {
                apiKey: "AIzaSyCKhN9jgbQVrUSbxMeD-1y4Ve3BV5-omA4",
                authDomain: "tetris-art-studio.firebaseapp.com",
                projectId: "tetris-art-studio",
                storageBucket: "tetris-art-studio.firebasestorage.app",
                messagingSenderId: "793493379153",
                appId: "1:793493379153:web:6c608c02b687d3e72ac070",
                measurementId: "G-WGY100LTG7"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // Enable persistence for better offline
            db.enablePersistence().catch(err => console.warn('Persistence failed:', err));

            const AudioSys = {
                ctx: null, enabled: true,
                init() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
                play(type) {
                    if (!this.enabled) return;
                    if (!this.ctx) this.init();
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    const now = this.ctx.currentTime;
                    switch(type) {
                        case 'place': osc.type='square'; osc.frequency.setValueAtTime(200,now); osc.frequency.exponentialRampToValueAtTime(400,now+0.1); gain.gain.setValueAtTime(0.15,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.15); osc.start(now); osc.stop(now+0.15); break;
                        case 'rotate': osc.type='sine'; osc.frequency.setValueAtTime(300,now); osc.frequency.linearRampToValueAtTime(500,now+0.05); gain.gain.setValueAtTime(0.1,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.05); osc.start(now); osc.stop(now+0.05); break;
                        case 'delete': osc.type='sawtooth'; osc.frequency.setValueAtTime(150,now); osc.frequency.exponentialRampToValueAtTime(50,now+0.1); gain.gain.setValueAtTime(0.1,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.1); osc.start(now); osc.stop(now+0.1); break;
                        case 'login': [523,659,784,1047].forEach((freq,i)=>{ let o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.connect(g); g.connect(this.ctx.destination); o.type='square'; o.frequency.value=freq; g.gain.setValueAtTime(0.1,now+i*0.1); g.gain.exponentialRampToValueAtTime(0.01,now+i*0.1+0.1); o.start(now+i*0.1); o.stop(now+i*0.1+0.1); }); break;
                        case 'error': osc.type='sawtooth'; osc.frequency.setValueAtTime(100,now); osc.frequency.linearRampToValueAtTime(50,now+0.2); gain.gain.setValueAtTime(0.2,now); gain.gain.exponentialRampToValueAtTime(0.01,now+0.2); osc.start(now); osc.stop(now+0.2); break;
                    }
                },
                toggle(enabled) { this.enabled = enabled; }
            };

            const CONFIG = {
                TILE_SIZE: 28, GRID_W: 32, GRID_H: 18,
                SHAPES: {
                    'I':{matrix:[[1,1,1,1]],color:'#00f0f0'}, 'J':{matrix:[[1,0,0],[1,1,1]],color:'#0000f0'},
                    'L':{matrix:[[0,0,1],[1,1,1]],color:'#f0a000'}, 'O':{matrix:[[1,1],[1,1]],color:'#f0f000'},
                    'S':{matrix:[[0,1,1],[1,1,0]],color:'#00f000'}, 'T':{matrix:[[0,1,0],[1,1,1]],color:'#a000f0'},
                    'Z':{matrix:[[1,1,0],[0,1,1]],color:'#f00000'}
                },
                PALETTE: ['#00f0f0','#0000f0','#f0a000','#f0f000','#00f000','#a000f0','#f00000','#ffffff','#ff00ff','#00ffff','#888888','#333333']
            };

            let State = {
                user: null, placedBlocks: [], history: [], currentShape:'T', currentMatrix:CONFIG.SHAPES.T.matrix,
                currentColor:CONFIG.SHAPES.T.color, blockType:'solid', opacity:1, canvas:null, ctx:null,
                previewCanvas:null, previewCtx:null, scale:1
            };

            // Local Storage Functions
            function saveDesignToLocal() {
                if (State.placedBlocks.length === 0) {
                    showNotification('No blocks to save!', true);
                    return;
                }

                // Create a thumbnail
                let tempCanvas = document.createElement('canvas');
                tempCanvas.width = 140;
                tempCanvas.height = 80;
                let tempCtx = tempCanvas.getContext('2d');
                tempCtx.fillStyle = '#0a0a1f';
                tempCtx.fillRect(0, 0, 140, 80);
                
                // Draw blocks on thumbnail
                State.placedBlocks.forEach(block => {
                    block.matrix.forEach((row, ri) => {
                        row.forEach((cell, ci) => {
                            if (cell) {
                                tempCtx.fillStyle = block.color;
                                tempCtx.fillRect(block.x * 2 + ci * 2, block.y * 2 + ri * 2, 2, 2);
                            }
                        });
                    });
                });
                
                let thumbnailUrl = tempCanvas.toDataURL('image/png');
                
                // Create design object
                let design = {
                    id: Date.now(),
                    username: State.user ? State.user.username : 'Guest',
                    blockCount: State.placedBlocks.length,
                    created: new Date().toISOString(),
                    blocks: State.placedBlocks.map(block => ({
                        x: block.x,
                        y: block.y,
                        color: block.color,
                        matrix: block.matrix.map(row => [...row])
                    })),
                    thumbnail: thumbnailUrl
                };
                
                // Get existing designs
                let designs = JSON.parse(localStorage.getItem('tetris_designs') || '[]');
                designs.unshift(design); // Add to beginning
                
                // Keep only last 20 designs
                if (designs.length > 20) designs.pop();
                
                localStorage.setItem('tetris_designs', JSON.stringify(designs));
                showNotification('Design saved locally!');
                
                // Also save page background if needed
                savePageBackground();
            }
            
            function savePageBackground() {
                if (State.placedBlocks.length === 0) return;
                
                let temp = document.createElement('canvas');
                temp.width = State.canvas.width;
                temp.height = State.canvas.height;
                let tCtx = temp.getContext('2d');
                tCtx.fillStyle = '#0a0a1f';
                tCtx.fillRect(0, 0, temp.width, temp.height);
                State.placedBlocks.forEach(block => drawBlock(tCtx, block.x, block.y, block.matrix, block.color));
                let dataUrl = temp.toDataURL('image/png');
                
                // Save as current background
                localStorage.setItem('tetris_current_background', dataUrl);
            }
            
            function loadDesignFromLocal(design) {
                if (design.blocks) {
                    State.placedBlocks = design.blocks.map(b => ({
                        x: b.x,
                        y: b.y,
                        color: b.color,
                        matrix: b.matrix.map(row => [...row])
                    }));
                    renderCanvas();
                    showNotification('Design loaded from local storage');
                }
            }
            
            function showLocalDesigns() {
                if (!State.user) {
                    showNotification('Please login first', true);
                    return;
                }
                
                let modal = document.getElementById('profile-modal');
                let gallery = document.getElementById('profile-gallery');
                
                let designs = JSON.parse(localStorage.getItem('tetris_designs') || '[]');
                
                // Filter designs by current user
                let userDesigns = designs.filter(d => d.username === State.user.username);
                
                let totalBlocks = userDesigns.reduce((acc, d) => acc + (d.blockCount || 0), 0);
                document.getElementById('total-blocks-all').innerText = totalBlocks;
                document.getElementById('total-designs').innerText = userDesigns.length;
                
                gallery.innerHTML = '';
                
                if (userDesigns.length === 0) {
                    gallery.innerHTML = '<p style="color:gray; text-align:center; padding:20px;">No designs yet. Create and save some!</p>';
                } else {
                    userDesigns.forEach(design => {
                        let card = document.createElement('div');
                        card.className = 'gallery-item';
                        
                        let thumbImg = document.createElement('img');
                        thumbImg.src = design.thumbnail;
                        thumbImg.style.width = '100%';
                        thumbImg.style.height = 'auto';
                        thumbImg.style.imageRendering = 'pixelated';
                        
                        let stats = document.createElement('div');
                        stats.className = 'gallery-stats';
                        let date = new Date(design.created).toLocaleDateString();
                        stats.innerHTML = `
                            <span class="gallery-username">${design.username}</span>
                            <span>${design.blockCount} blocks</span>
                            <span>üìÖ ${date}</span>
                        `;
                        
                        card.appendChild(thumbImg);
                        card.appendChild(stats);
                        
                        card.onclick = () => {
                            loadDesignFromLocal(design);
                            modal.classList.remove('active');
                        };
                        
                        gallery.appendChild(card);
                    });
                }
                
                modal.classList.add('active');
            }
            
            // Keep original profile modal function but redirect to local
            window.showProfileModal = showLocalDesigns;
            
            function hideProfileModal() {
                document.getElementById('profile-modal').classList.remove('active');
            }

            window.onload = function() {
                for (let i=0; i<10; i++) {
                    let block = document.createElement('div');
                    block.className='floating-block';
                    block.style.left=Math.random()*100+'%';
                    block.style.animationDelay=Math.random()*20+'s';
                    block.style.background=`var(--tetris-${['cyan','blue','orange','yellow','green','purple','red'][Math.floor(Math.random()*7)]})`;
                    document.getElementById('floating-blocks').appendChild(block);
                }
                setTimeout(()=>{ document.getElementById('loading-screen').style.opacity='0'; setTimeout(()=>document.getElementById('loading-screen').style.display='none',500); },2000);

                State.canvas = document.getElementById('art-canvas');
                State.ctx = State.canvas.getContext('2d');
                State.previewCanvas = document.getElementById('block-preview');
                State.previewCtx = State.previewCanvas.getContext('2d');
                State.canvas.width = CONFIG.GRID_W * CONFIG.TILE_SIZE;
                State.canvas.height = CONFIG.GRID_H * CONFIG.TILE_SIZE;

                initShapeSelector();
                initColorPicker();
                setupEventListeners();
                auth.onAuthStateChanged(user => { if (user) loadUserData(user); });

                document.getElementById('scale-slider').addEventListener('input', (e) => {
                    State.scale = parseFloat(e.target.value);
                    document.getElementById('scale-value').textContent = Math.round(State.scale*100)+'%';
                    applyCanvasScale();
                });
                document.getElementById('opacity-slider').addEventListener('input', (e) => {
                    State.opacity = parseFloat(e.target.value);
                    document.getElementById('opacity-value').textContent = Math.round(State.opacity*100)+'%';
                });
                document.getElementById('sound-toggle').addEventListener('change', (e) => AudioSys.toggle(e.target.checked));
                document.getElementById('custom-color').addEventListener('input', (e) => document.getElementById('custom-hex').value = e.target.value);
                document.getElementById('custom-hex').addEventListener('input', (e) => { if (/^#[0-9A-F]{6}$/i.test(e.target.value)) document.getElementById('custom-color').value = e.target.value; });
                renderCanvas();
                
                // Load saved page background
                let savedBg = localStorage.getItem('tetris_current_background');
                if (savedBg) {
                    document.body.style.backgroundImage = `url(${savedBg})`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundRepeat = 'no-repeat';
                }
            };

            function applyCanvasScale() {
                let scale = Math.min(State.scale, 1.8);
                State.canvas.style.width = (State.canvas.width * scale) + 'px';
                State.canvas.style.height = (State.canvas.height * scale) + 'px';
            }

            function setBlockType(type) {
                State.blockType = type;
                document.querySelectorAll('.block-type-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                renderCanvas();
            }

            function applyCustomColor() {
                State.currentColor = document.getElementById('custom-color').value;
                document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
                AudioSys.play('rotate');
            }

            function previewBackground() {
                if (State.placedBlocks.length===0) { showNotification('No blocks to preview!',true); return; }
                let previewCanvas = document.getElementById('bg-preview-canvas');
                previewCanvas.width = State.canvas.width; previewCanvas.height = State.canvas.height;
                let ctx = previewCanvas.getContext('2d');
                ctx.fillStyle = '#0a0a1f'; ctx.fillRect(0,0,previewCanvas.width,previewCanvas.height);
                State.placedBlocks.forEach(block => drawBlock(ctx, block.x, block.y, block.matrix, block.color));
                document.getElementById('bg-preview-modal').classList.add('active');
                AudioSys.play('rotate');
            }
            
            function hideBackgroundPreview() { document.getElementById('bg-preview-modal').classList.remove('active'); }
            
            function confirmApplyBackground() { 
                applyAsPageBackground(); 
                hideBackgroundPreview(); 
            }

            function setCanvasBackground() {
                if (State.placedBlocks.length===0) { showNotification('No blocks to set as canvas background',true); return; }
                let temp = document.createElement('canvas'); temp.width=State.canvas.width; temp.height=State.canvas.height;
                let tCtx = temp.getContext('2d'); tCtx.fillStyle='#0a0a1f'; tCtx.fillRect(0,0,temp.width,temp.height);
                State.placedBlocks.forEach(block=>drawBlock(tCtx,block.x,block.y,block.matrix,block.color));
                let dataUrl = temp.toDataURL('image/png');
                document.getElementById('canvas-wrapper').style.backgroundImage = `url(${dataUrl})`;
                document.getElementById('canvas-wrapper').style.backgroundSize = 'contain';
                document.getElementById('canvas-wrapper').style.backgroundRepeat = 'no-repeat';
                document.getElementById('canvas-wrapper').style.backgroundPosition = 'center';
                showNotification('Canvas background set!');
            }

            function initShapeSelector() {
                let container = document.getElementById('shape-selector');
                Object.keys(CONFIG.SHAPES).forEach(key => {
                    let btn = document.createElement('div');
                    btn.className = 'shape-btn' + (key==='T'?' active':'');
                    btn.textContent = key;
                    btn.onclick = () => selectShape(key, btn);
                    container.appendChild(btn);
                });
            }
            
            function initColorPicker() {
                let container = document.getElementById('color-picker');
                CONFIG.PALETTE.forEach((color,index) => {
                    let btn = document.createElement('div');
                    btn.className = 'color-btn' + (index===5?' active':'');
                    btn.style.background = color;
                    btn.onclick = () => selectColor(color, btn);
                    container.appendChild(btn);
                });
            }
            
            function selectShape(key, btn) {
                document.querySelectorAll('.shape-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                State.currentShape = key;
                State.currentMatrix = CONFIG.SHAPES[key].matrix;
                State.currentColor = CONFIG.SHAPES[key].color;
                let colorBtns = document.querySelectorAll('.color-btn');
                colorBtns.forEach(b=>b.classList.remove('active'));
                let colorIndex = CONFIG.PALETTE.findIndex(c=>c===CONFIG.SHAPES[key].color);
                if (colorIndex!==-1) colorBtns[colorIndex].classList.add('active');
                AudioSys.play('rotate');
            }
            
            function selectColor(color, btn) {
                document.querySelectorAll('.color-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                State.currentColor = color;
                document.getElementById('custom-color').value = color;
                document.getElementById('custom-hex').value = color;
            }

            function setupEventListeners() {
                let canvas = State.canvas;
                canvas.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    let rect = canvas.getBoundingClientRect();
                    let scale = State.scale;
                    let x = Math.floor((e.clientX - rect.left) / (CONFIG.TILE_SIZE * scale));
                    let y = Math.floor((e.clientY - rect.top) / (CONFIG.TILE_SIZE * scale));
                    if (x>=0 && y>=0 && x<CONFIG.GRID_W && y<CONFIG.GRID_H) {
                        if (e.button === 0) placeBlock(x, y);
                        else if (e.button === 2) deleteBlock(x, y);
                    }
                });
                canvas.addEventListener('contextmenu', e=>e.preventDefault());
                canvas.addEventListener('wheel', e=>{ e.preventDefault(); rotateShape(); });
                document.addEventListener('keydown', e=>{
                    if (!document.getElementById('login-screen').classList.contains('hidden')) return;
                    if (e.key==='r'||e.key==='R') rotateShape();
                    else if (e.ctrlKey && e.key==='z') { e.preventDefault(); undoAction(); }
                });
                document.addEventListener('mousemove', e=>{
                    if (document.getElementById('login-screen').classList.contains('hidden') && document.getElementById('app-container').classList.contains('visible'))
                        updatePreview(e);
                });
                document.getElementById('canvas-wrapper').addEventListener('mouseleave', ()=> State.previewCanvas.style.display='none');
            }

            function renderCanvas() {
                let ctx = State.ctx;
                ctx.clearRect(0,0,State.canvas.width,State.canvas.height);
                // grid
                ctx.strokeStyle = 'rgba(0,240,240,0.2)';
                for (let x=0;x<=CONFIG.GRID_W;x++) {
                    ctx.beginPath(); ctx.moveTo(x*CONFIG.TILE_SIZE,0); ctx.lineTo(x*CONFIG.TILE_SIZE,State.canvas.height);
                    ctx.strokeStyle = x%4===0?'rgba(240,240,0,0.3)':'rgba(0,240,240,0.2)'; ctx.stroke();
                }
                for (let y=0;y<=CONFIG.GRID_H;y++) {
                    ctx.beginPath(); ctx.moveTo(0,y*CONFIG.TILE_SIZE); ctx.lineTo(State.canvas.width,y*CONFIG.TILE_SIZE);
                    ctx.strokeStyle = y%4===0?'rgba(240,240,0,0.3)':'rgba(0,240,240,0.2)'; ctx.stroke();
                }
                State.placedBlocks.forEach(block => drawBlock(ctx, block.x, block.y, block.matrix, block.color));
                document.getElementById('block-count').textContent = State.placedBlocks.length;
            }

            function drawBlock(ctx, gridX, gridY, matrix, color) {
                let size = CONFIG.TILE_SIZE;
                let x = gridX*size, y = gridY*size;
                let opacity = State.opacity;
                matrix.forEach((row,rowIndex)=> row.forEach((cell,colIndex)=>{
                    if (cell) {
                        let px = x+colIndex*size, py = y+rowIndex*size;
                        ctx.globalAlpha = opacity;
                        if (State.blockType==='solid') { ctx.fillStyle=color; ctx.fillRect(px+1,py+1,size-2,size-2); }
                        else if (State.blockType==='outline') { ctx.strokeStyle=color; ctx.lineWidth=3; ctx.strokeRect(px+2,py+2,size-4,size-4); }
                        else if (State.blockType==='glow') { ctx.shadowColor=color; ctx.shadowBlur=10; ctx.fillStyle=color; ctx.fillRect(px+1,py+1,size-2,size-2); ctx.shadowBlur=0; }
                        else if (State.blockType==='3d') {
                            ctx.fillStyle=color; ctx.fillRect(px+1,py+1,size-2,size-2);
                            ctx.fillStyle='rgba(255,255,255,0.4)'; ctx.fillRect(px+1,py+1,size-2,4); ctx.fillRect(px+1,py+1,4,size-2);
                            ctx.fillStyle='rgba(0,0,0,0.4)'; ctx.fillRect(px+1,py+size-5,size-2,4); ctx.fillRect(px+size-5,py+1,4,size-2);
                        }
                        ctx.globalAlpha=1;
                    }
                }));
            }

            function updatePreview(e) {
                let preview = State.previewCanvas, ctx = State.previewCtx;
                let rows = State.currentMatrix.length, cols = State.currentMatrix[0].length;
                preview.width = cols*CONFIG.TILE_SIZE; preview.height = rows*CONFIG.TILE_SIZE;
                ctx.clearRect(0,0,preview.width,preview.height);
                State.currentMatrix.forEach((row,rowIndex)=> row.forEach((cell,colIndex)=>{
                    if (cell) {
                        let x = colIndex*CONFIG.TILE_SIZE, y = rowIndex*CONFIG.TILE_SIZE;
                        ctx.fillStyle = State.currentColor; ctx.globalAlpha=0.7;
                        if (State.blockType==='glow') ctx.shadowColor=State.currentColor, ctx.shadowBlur=10;
                        ctx.fillRect(x+1,y+1,CONFIG.TILE_SIZE-2,CONFIG.TILE_SIZE-2);
                        ctx.shadowBlur=0; ctx.globalAlpha=1;
                    }
                }));
                preview.style.display = 'block';
                preview.style.left = (e.clientX+20)+'px';
                preview.style.top = (e.clientY+20)+'px';
            }

            function placeBlock(x,y) {
                saveHistory();
                if (!canPlace(x,y,State.currentMatrix)) { AudioSys.play('error'); return; }
                State.placedBlocks.push({x,y,matrix:JSON.parse(JSON.stringify(State.currentMatrix)),color:State.currentColor});
                AudioSys.play('place'); renderCanvas();
            }
            
            function deleteBlock(x,y) {
                saveHistory();
                let index = State.placedBlocks.findIndex(block => {
                    let m=block.matrix, lx=x-block.x, ly=y-block.y;
                    return ly>=0 && ly<m.length && lx>=0 && lx<m[0].length && m[ly][lx];
                });
                if (index!==-1) { State.placedBlocks.splice(index,1); AudioSys.play('delete'); renderCanvas(); }
            }
            
            function canPlace(x,y,matrix) {
                for (let r=0; r<matrix.length; r++) for (let c=0; c<matrix[r].length; c++) if (matrix[r][c]) {
                    let wx=x+c, wy=y+r;
                    if (wx<0||wx>=CONFIG.GRID_W||wy<0||wy>=CONFIG.GRID_H) return false;
                    if (State.placedBlocks.some(block=> {
                        let lx=wx-block.x, ly=wy-block.y;
                        return ly>=0 && ly<block.matrix.length && lx>=0 && lx<block.matrix[0].length && block.matrix[ly][lx];
                    })) return false;
                }
                return true;
            }
            
            function rotateShape() {
                let matrix = State.currentMatrix;
                State.currentMatrix = matrix[0].map((_,idx)=> matrix.map(row=>row[idx]).reverse());
                AudioSys.play('rotate');
            }
            
            function saveHistory() { State.history.push(JSON.stringify(State.placedBlocks)); if (State.history.length>50) State.history.shift(); }
            
            function undoAction() { if (State.history.length>0) { State.placedBlocks=JSON.parse(State.history.pop()); renderCanvas(); AudioSys.play('rotate'); } }
            
            function clearCanvas() { if (State.placedBlocks.length===0) return; saveHistory(); State.placedBlocks=[]; AudioSys.play('delete'); renderCanvas(); showNotification('Canvas cleared!'); }

            function applyAsPageBackground() {
                if (State.placedBlocks.length === 0) {
                    showNotification('No blocks to set as background!', true);
                    return;
                }
                
                let temp = document.createElement('canvas'); 
                temp.width = State.canvas.width; 
                temp.height = State.canvas.height;
                let tCtx = temp.getContext('2d'); 
                tCtx.fillStyle = '#0a0a1f'; 
                tCtx.fillRect(0, 0, temp.width, temp.height);
                State.placedBlocks.forEach(block => drawBlock(tCtx, block.x, block.y, block.matrix, block.color));
                let dataUrl = temp.toDataURL('image/png');
                
                // Apply to body with proper settings
                document.body.style.backgroundImage = `url(${dataUrl})`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundRepeat = 'no-repeat';
                
                // Save to localStorage
                localStorage.setItem('tetris_current_background', dataUrl);
                
                AudioSys.play('place'); 
                showNotification('Page background applied!');
            }

            function downloadBackground() {
                let temp = document.createElement('canvas'); temp.width=State.canvas.width; temp.height=State.canvas.height;
                let tCtx = temp.getContext('2d'); tCtx.fillStyle='#0a0a1f'; tCtx.fillRect(0,0,temp.width,temp.height);
                State.placedBlocks.forEach(block=>drawBlock(tCtx,block.x,block.y,block.matrix,block.color));
                let link = document.createElement('a'); link.download = `tetris-art-${Date.now()}.png`; link.href = temp.toDataURL('image/png'); link.click();
                showNotification('Image downloaded!');
            }

            // AUTH
            function showRegisterModal() { document.getElementById('register-modal').classList.add('active'); }
            function hideRegisterModal() { document.getElementById('register-modal').classList.remove('active'); }
            
            function handleRegister() {
                let username = document.getElementById('reg-username').value.trim();
                let email = document.getElementById('reg-email').value.trim();
                let pwd = document.getElementById('reg-password').value;
                let conf = document.getElementById('reg-confirm').value;
                if (!username||!email||!pwd||!conf) { AudioSys.play('error'); showNotification('Fill all fields!',true); return; }
                if (pwd!==conf) { AudioSys.play('error'); showNotification('Passwords mismatch!',true); return; }
                if (pwd.length<6) { AudioSys.play('error'); showNotification('Min 6 chars',true); return; }
                auth.createUserWithEmailAndPassword(email,pwd).then(cred=>{
                    return db.collection('users').doc(cred.user.uid).set({ username, email, level:1, created:firebase.firestore.FieldValue.serverTimestamp() })
                    .then(()=>cred.user.updateProfile({displayName:username}));
                }).then(()=>{ AudioSys.play('login'); showNotification('Account created!'); hideRegisterModal(); document.getElementById('login-email').value=email; })
                .catch(err=>{ AudioSys.play('error'); showNotification(err.message,true); });
            }
            
            function handleLogin() {
                let email = document.getElementById('login-email').value.trim();
                let pwd = document.getElementById('login-password').value;
                if (!email||!pwd) { AudioSys.play('error'); showNotification('Fill fields',true); return; }
                auth.signInWithEmailAndPassword(email,pwd).then(cred=>loadUserData(cred.user)).catch(err=>{ AudioSys.play('error'); showNotification(err.message,true); });
            }
            
            function loadUserData(user) {
                return db.collection('users').doc(user.uid).get().then(doc=>{
                    if (doc.exists) {
                        State.user = { id:user.uid, username:doc.data().username, email:user.email, level:doc.data().level||1 };
                        localStorage.setItem('tetris_user', JSON.stringify(State.user));
                        AudioSys.play('login');
                        showApp();
                    }
                });
            }
            
            function showApp() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.add('visible');
                document.getElementById('display-username').textContent = State.user.username;
                document.getElementById('user-avatar').textContent = State.user.username[0].toUpperCase();
                document.getElementById('user-level').textContent = State.user.level;
                applyCanvasScale();
            }
            
            function logout() {
                auth.signOut().then(()=>{
                    localStorage.removeItem('tetris_user');
                    State.user=null; State.placedBlocks=[]; State.history=[];
                    document.getElementById('app-container').classList.remove('visible');
                    document.getElementById('login-screen').classList.remove('hidden');
                    renderCanvas(); showNotification('Logged out');
                });
            }

            function showNotification(msg, isErr=false) {
                let n = document.getElementById('notification');
                n.textContent = msg; n.className = isErr ? 'error show' : 'show';
                setTimeout(()=> n.classList.remove('show'), 3000);
            }

            // Expose globals
            window.selectShape = selectShape; 
            window.selectColor = selectColor; 
            window.rotateShape = rotateShape;
            window.undoAction = undoAction; 
            window.clearCanvas = clearCanvas; 
            window.previewBackground = previewBackground;
            window.confirmApplyBackground = confirmApplyBackground; 
            window.hideBackgroundPreview = hideBackgroundPreview;
            window.logout = logout;
            window.handleLogin = handleLogin; 
            window.handleRegister = handleRegister; 
            window.showRegisterModal = showRegisterModal;
            window.hideRegisterModal = hideRegisterModal; 
            window.downloadBackground = downloadBackground;
            window.setBlockType = setBlockType; 
            window.applyCustomColor = applyCustomColor;
            window.setCanvasBackground = setCanvasBackground;
            window.saveDesignToLocal = saveDesignToLocal;
            window.showLocalDesigns = showLocalDesigns;
            window.hideProfileModal = hideProfileModal;
            window.showProfileModal = showLocalDesigns; // Override profile to use local
        })();
    </script>
</body>

</html>
